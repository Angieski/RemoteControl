# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a production-ready Electron-based remote control application that provides AnyDesk/TeamViewer-style functionality. The application supports both local network and internet-based remote desktop control with a dual-architecture approach: direct P2P connections for LAN and relay server for internet connectivity.

## Core Architecture

### Dual Connection System
- **Local Mode**: Direct WebSocket connections on port 3000 for LAN usage
- **Internet Mode**: Central relay server (port 8080) with 9-digit client IDs for NAT traversal
- **Hybrid Integration**: `screen-relay-bridge.js` connects both systems seamlessly

### Key Components Structure
```
src/
├── main.js              # Electron main process + server orchestration
├── preload.js           # Secure IPC bridge via contextBridge
├── server/              # Local WebSocket server components
│   ├── index.js         # Main server with client management
│   ├── screenCapture.js # Screen capture (node-screenshots + Sharp)
│   ├── inputController.js # Mouse/keyboard control (@hurdlegroup/robotjs)
│   └── authentication.js # 6-digit temporary access codes
├── renderer/            # Frontend Electron UI
├── client/relay-client.js # Internet relay client integration
└── integrator/screen-relay-bridge.js # Bridge relay ↔ local systems
```

### Relay Server Architecture
- **Location**: `relay-server/` (separate Node.js server)
- **Purpose**: Central relay for internet connections with AnyDesk-style 9-digit IDs
- **Deployment**: Designed for VPS/cloud hosting (documented in `ANYDESK_SETUP.md`)

## Common Development Commands

### Development & Testing
```bash
npm run dev        # Development mode with hot-reload (concurrently server + electron)
npm start          # Production mode
npm run server     # Backend WebSocket server only (port 3000)
```

### Building Distributables
```bash
npm run build:win  # Windows executable (NSIS installer + portable)
npm run build:all  # All platforms (Windows, Linux AppImage/DEB, macOS DMG)
```

### Relay Server (separate deployment)
```bash
cd relay-server
npm install
npm start          # Production relay server (port 8080)
```

## Critical Dependencies

### Production Critical
- `@hurdlegroup/robotjs@0.12.3`: **USE THIS VERSION** - Original robotjs fails to compile on Node.js 22
- `node-screenshots`: Primary screen capture engine
- `sharp`: JPEG compression and image processing
- `ws`: WebSocket server/client communication

### Version Tracking
- Current app version: `1.0.2` (check package.json)
- Increment version for each build: `1.0.2` → `1.0.3`

## Authentication System

The app uses a **6-digit temporary access code system**:
- Codes expire in 5 minutes (configurable in settings)
- Generated by host, entered by viewer
- Managed via `src/server/authentication.js`
- UI integration in renderer with real-time expiration display

## Screen Capture & Performance

### Configuration Options
- **Quality**: 1-100 (default 80) - affects JPEG compression
- **Scale**: 0.1-2.0 (default 1.0) - output resolution scaling
- **Frame Rate**: ~10 FPS (100ms intervals)
- **Typical file size**: ~192KB per frame

### Integration Points
- Main capture: `screenCapture.js` using node-screenshots
- Compression: Sharp library with configurable quality
- Relay integration: `screen-relay-bridge.js` handles internet routing

## Build System

### Electron Builder Configuration
- **Windows**: NSIS installer + portable executable
- **Output**: `dist/` directory
- **Icons**: `build/icon.png` (with fallback path detection in main.js)
- **Auto-updater**: Configured but not implemented

### Version Management
- Update `package.json` version before building
- Use semantic versioning (1.0.x for patches, 1.x.0 for features)
- Both main and relay-server have separate package.json files

## Network & Connectivity

### Local Network (Primary)
- **Port**: 3000 (WebSocket + HTTP)
- **Protocol**: Direct client connections
- **Authentication**: 6-digit codes
- **IP Detection**: WebRTC-based local IP discovery

### Internet Mode (Relay)
- **Server URL**: Configurable in `relay-client.js` (line 10)
- **Default**: `ws://localhost:8080` (change for production)
- **ID System**: 9-digit unique identifiers like AnyDesk
- **Connection Flow**: ID → Request → Approval → Session

## Security Considerations

### Current Implementation
- Temporary access codes with expiration
- Local network isolation by default
- Input validation in inputController.js
- Secure IPC via preload.js contextBridge

### Production Deployment
- Use WSS (secure WebSocket) for relay server
- SSL/TLS via Nginx reverse proxy (documented in `ANYDESK_SETUP.md`)
- Firewall configuration for appropriate ports only

## Error Handling & Known Issues

### Fixed Issues (Reference)
- **RobotJS compilation**: Resolved by using `@hurdlegroup/robotjs@0.12.3`
- **Icon path errors**: Resolved with fallback detection in main.js
- **Connection status**: Fixed dual connection status display

### Testing Integration
- **No specific test framework configured**
- Test via npm run dev and manual verification
- Check both local network and relay connectivity modes

## Deployment Documentation

- **Complete setup guide**: `ANYDESK_SETUP.md`
- **Automated deployment**: `deploy/deploy.sh` script
- **Environment config**: `relay-server/.env.example`
- **Production hosting**: Designed for Hostinger/VPS deployment

## Code Integration Points

### Adding New Features
- **Screen capture modifications**: Edit `screenCapture.js`
- **Input control enhancements**: Modify `inputController.js`
- **UI changes**: Update `renderer/` components
- **Relay functionality**: Extend `relay-client.js` and bridge integration

### Testing Changes
- Test local connections first (npm run dev)
- Verify relay integration if internet features modified
- Build and test executable before distribution
- Check both host and viewer modes

## Development Workflow Integration

When making changes:
1. Use `npm run dev` for live development
2. Test both host and viewer modes
3. Verify local network functionality first
4. Test relay integration if applicable
5. Update version in package.json
6. Build executable with `npm run build:win`
7. Test built executable on clean system