# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a production-ready Electron-based remote control application that provides AnyDesk/TeamViewer-style functionality. The application supports both local network and internet-based remote desktop control with a dual-architecture approach: direct P2P connections for LAN and relay server for internet connectivity.

## Core Architecture

### Dual Connection System
- **Local Mode**: Direct WebSocket connections on port 3000 for LAN usage
- **Internet Mode**: Central relay server (port 8080) with 9-digit client IDs for NAT traversal
- **Hybrid Integration**: `screen-relay-bridge.js` connects both systems seamlessly

### Key Components Structure
```
src/
├── main.js              # Electron main process + server orchestration
├── preload.js           # Secure IPC bridge via contextBridge
├── server/              # Local WebSocket server components
│   ├── index.js         # Main server with client management
│   ├── screenCapture.js # Screen capture (node-screenshots + Sharp)
│   ├── inputController.js # Mouse/keyboard control (@hurdlegroup/robotjs)
│   └── authentication.js # 6-digit temporary access codes
├── renderer/            # Frontend Electron UI
├── client/relay-client.js # Internet relay client integration
└── integrator/screen-relay-bridge.js # Bridge relay ↔ local systems
```

### Relay Server Architecture
- **Location**: `relay-server/` (separate Node.js server)
- **Purpose**: Central relay for internet connections with AnyDesk-style 9-digit IDs
- **Deployment**: Designed for VPS/cloud hosting (documented in `ANYDESK_SETUP.md`)

## Common Development Commands

### Development & Testing
```bash
npm run dev        # Development mode with hot-reload (concurrently server + electron)
npm start          # Production mode
npm run server     # Backend WebSocket server only (port 3000)
```

### Building Distributables
```bash
npm run build:win    # Windows executable (NSIS installer + portable)
npm run build:linux  # Linux (AppImage + DEB)
npm run build:mac    # macOS (DMG for Intel + ARM64)
npm run build:all    # All platforms (Windows, Linux, macOS)
npm run pack         # Package without installer (for testing)
```

### Relay Server (separate deployment)
```bash
cd relay-server
npm install
npm start          # Production relay server (port 8080)
npm run dev        # Development mode with nodemon
```

## Critical Dependencies

### Production Critical
- `@hurdlegroup/robotjs@0.12.3`: **USE THIS VERSION** - Original robotjs fails to compile on Node.js 22
- `node-screenshots`: Primary screen capture engine
- `sharp`: JPEG compression and image processing
- `ws`: WebSocket server/client communication

### Version Tracking
- Current app version: `1.1.2` (check package.json)
- Increment version for each build: `1.1.2` → `1.1.3`
- Relay server version: `1.0.0` (separate versioning in relay-server/package.json)

## Authentication System

The app uses a **6-digit temporary access code system**:
- Codes expire in 5 minutes (configurable in settings)
- Generated by host, entered by viewer
- Managed via `src/server/authentication.js`
- UI integration in renderer with real-time expiration display

## Screen Capture & Performance

### Configuration Options
- **Quality**: 1-100 (default 80) - affects JPEG compression
- **Scale**: 0.1-2.0 (default 1.0) - output resolution scaling
- **Frame Rate**: ~10 FPS (100ms intervals)
- **Typical file size**: ~192KB per frame

### Integration Points
- Main capture: `screenCapture.js` using node-screenshots
- Compression: Sharp library with configurable quality
- Relay integration: `screen-relay-bridge.js` handles internet routing

## Build System

### Electron Builder Configuration
- **Windows**: NSIS installer + portable executable
- **Output**: `dist/` directory
- **Icons**: `build/icon.png` (with fallback path detection in main.js)
- **Auto-updater**: Configured but not implemented

### Version Management
- Update `package.json` version before building
- Use semantic versioning (1.0.x for patches, 1.x.0 for features)
- Both main and relay-server have separate package.json files

## Network & Connectivity

### Local Network (Primary)
- **Port**: 3000 (WebSocket + HTTP)
- **Protocol**: Direct client connections
- **Authentication**: 6-digit codes
- **IP Detection**: WebRTC-based local IP discovery

### Internet Mode (Relay)
- **Server URL**: Configurable in `relay-client.js` (line 11)
- **Production URL**: `ws://54.232.138.198:8080` (AWS EC2 instance)
- **ID System**: 9-digit unique identifiers like AnyDesk
- **Connection Flow**: ID → Request → Approval → Session
- **Features**: Heartbeat monitoring, session cleanup, connection requests

## Security Considerations

### Current Implementation
- Temporary access codes with expiration
- Local network isolation by default
- Input validation in inputController.js
- Secure IPC via preload.js contextBridge

### Production Deployment
- Use WSS (secure WebSocket) for relay server
- SSL/TLS via Nginx reverse proxy (documented in `ANYDESK_SETUP.md`)
- Firewall configuration for appropriate ports only

## Error Handling & Known Issues

### Fixed Issues (Reference)
- **RobotJS compilation**: Resolved by using `@hurdlegroup/robotjs@0.12.3`
- **Icon path errors**: Resolved with fallback detection in main.js
- **Connection status**: Fixed dual connection status display

### Testing Integration
- **No specific test framework configured** 
- Manual testing workflow:
  1. Use `npm run dev` for development testing
  2. Test both host and viewer modes in same session
  3. Verify local network functionality (port 3000)
  4. Test relay server integration if internet features modified
  5. Build and test executable with `npm run pack` before full distribution
- Quick relay server test: `cd relay-server && npm run test`

## Deployment Documentation

- **Complete setup guide**: `ANYDESK_SETUP.md`
- **Automated deployment**: `deploy/deploy.sh` script
- **Environment config**: `relay-server/.env.example`
- **Production hosting**: Designed for Hostinger/VPS deployment

## Code Integration Points

### Adding New Features
- **Screen capture modifications**: Edit `screenCapture.js`
- **Input control enhancements**: Modify `inputController.js`
- **UI changes**: Update `renderer/` components
- **Relay functionality**: Extend `relay-client.js` and bridge integration

### Testing Changes
- Always test local connections first (`npm run dev`)
- Test both host and viewer modes thoroughly
- Verify relay integration if internet features modified
- Use `npm run pack` to test build without creating installer
- Test final executable on clean system before distribution

## Development Workflow Integration

When making changes:
1. Use `npm run dev` for live development
2. Test both host and viewer modes
3. Verify local network functionality first
4. Test relay integration if applicable
5. Update version in package.json
6. Build executable with `npm run build:win`
7. Test built executable on clean system

## Relay Server Management

### Production Server
- **Location**: AWS EC2 instance at `54.232.138.198:8080`
- **Status endpoints**: `/health`, `/stats`
- **Features**: Auto-cleanup of offline clients and expired sessions
- **Monitoring**: Built-in heartbeat system and connection logging

### Client Connection Process
1. **Host Mode**: Register as host → Receive 9-digit ID → Wait for connections
2. **Viewer Mode**: Register as viewer → Request connection to target ID → Wait for approval
3. **Session**: Bidirectional data relay for screen capture and input events

## Key IPC Methods (main.js)
- `generate-access-code`: Generate 6-digit temporary codes
- `get-server-info`: Get local server status and client count
- `capture-screen-relay`: Screen capture for relay integration
- `send-input-relay`: Process remote input commands
- `start-server`: Initialize local WebSocket server
- `stop-server`: Shutdown server and cleanup connections

## Platform-Specific Considerations

### Windows
- Requires Visual Studio Build Tools for robotjs compilation
- Icon path detection with multiple fallback locations
- NSIS installer configuration with desktop/start menu shortcuts
- Portable executable also generated alongside installer

### Cross-Platform Dependencies
- `@hurdlegroup/robotjs@0.12.3`: **CRITICAL** - Use exact version for Node.js 22 compatibility
- Native dependency rebuild required after Node.js version changes
- Screen capture permissions vary by platform (macOS requires explicit permission)